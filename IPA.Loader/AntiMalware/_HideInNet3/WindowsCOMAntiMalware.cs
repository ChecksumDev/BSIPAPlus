#nullable enable
using IPA.AntiMalware.ComAPI;
using IPA.Logging;
using System;
using System.IO;
using System.Runtime.InteropServices;

namespace IPA.AntiMalware
{
    internal class WindowsCOMAntiMalware : IAntiMalware
    {
        private readonly IAntimalware amInterface;

        private WindowsCOMAntiMalware()
        {
            int hr = CoCreateInstanceAM(AmsiConstants.CAntimalwareGuid,
                null,
                0x1 | 0x4 /* inproc server, local server */,
                AmsiConstants.IAntimalwareGuid,
                out IAntimalware? antimalware);
            Marshal.ThrowExceptionForHR(hr);

            amInterface = antimalware;
        }

        public ScanResult ScanFile(FileInfo file)
        {
            using AmsiFileStream? stream = new(file, IntPtr.Zero);
            amInterface.Scan(stream, out AmsiResult result, out IAntimalwareProvider? provider);
            Logger.AntiMalware.Trace($"Scanned file '{file}' with {provider.DisplayName()}, and got '{result}'");
            return ScanResultFromAmsiResult(result);
        }

        public ScanResult ScanData(byte[] data, string? contentName = null)
        {
            contentName ??= $"unknown_data_{Guid.NewGuid()}";
            using AmsiMemoryStream? stream = new(contentName, data, IntPtr.Zero);
            amInterface.Scan(stream, out AmsiResult result, out IAntimalwareProvider? provider);
            Logger.AntiMalware.Trace(
                $"Scanned data named '{contentName}' with {provider.DisplayName()}, and got '{result}'");
            return ScanResultFromAmsiResult(result);
        }

        internal static WindowsCOMAntiMalware? TryInitialize()
        {
            // Mono's COM interop *fundamentally doesn't work.*
            // End of story.
#if false
            try
            {
                return new();
            }
            catch (Exception e)
            {
                Logger.AntiMalware.Warn("Could not initialize COM-based antimalware engine:");
                Logger.AntiMalware.Warn(e);
            }
#endif
            return null;
        }

        [DllImport("ole32",
            CallingConvention = CallingConvention.Winapi,
            ExactSpelling = true,
            PreserveSig = false,
            EntryPoint = "CoCreateInstance")]
        [DefaultDllImportSearchPaths(DllImportSearchPath.System32)]
        private static extern int CoCreateInstanceAM(
            [In] in Guid clsid,
            [In] [MarshalAs(UnmanagedType.Interface)]
            object? unkOuter,
            [In] int dwClsContext,
            [In] in Guid iid,
            [Out] [MarshalAs(UnmanagedType.Interface)]
            out IAntimalware @interface);


        private static ScanResult ScanResultFromAmsiResult(AmsiResult result)
        {
            return result switch
            {
                AmsiResult.Clean => ScanResult.KnownSafe,
                AmsiResult.NotDetected => ScanResult.NotDetected,
                AmsiResult.Detected => ScanResult.Detected,
                _ => ScanResult.MaybeMalware
            };
        }
    }
}